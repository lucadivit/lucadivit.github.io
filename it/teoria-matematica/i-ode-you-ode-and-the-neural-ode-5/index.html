<!DOCTYPE html>
<html lang="it">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" type="text/css" href="/css/elegant.prod.9e9d5ce754.css" media="screen">
        <link rel="stylesheet" type="text/css" href="/css/custom.css" media="screen">

        <link rel="dns-prefetch" href="//fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin>
        <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script src="https://unpkg.com/tocbot/dist/tocbot.min.js"></script>
        <script>
          document.addEventListener('DOMContentLoaded', function () {
            tocbot.init({
              tocSelector: '#toc-list',
              contentSelector: '.article-content',
              headingSelector: 'h3, h4, h5',
              hasInnerContainers: true,
              collapseDepth: 3,
              scrollSmooth: true
            });
            window.addEventListener('load', function () {
              try { tocbot.refresh(); } catch (e) {}
            });
          });
        </script>

        <script defer src="//cloud.umami.is/script.js" data-website-id="47e58b32-f06a-4bdf-92ac-69fafdb4e5a3"></script>
        <meta name="author" content="Luca Di Vita" />

        <meta name="description" content="Dai che ci siamo. Siamo arrivati alla quinta e ultima parte della serie sulle NODE. Prendete questa affermazione con le pinze però, che se non mi basta questo spazio vi beccate anche la sesta. In ogni caso in questa (spero) ultima parte, vedremo un po&#39; di codice e di applicazione …
" />
        <meta property="og:type" content="article" />
        <meta name="twitter:card" content="summary">

<meta name="keywords" content="deep_learning, matematica, neural_ode, reti_neurali, equazioni_differenziali, ode, teoria, metodi_numerici, Teoria & Matematica, " />

<meta property="og:title" content="Io ODO, Tu ODI e la Neural ODE - 5 "/>
<meta property="og:url" content="https://www.lucadivita.it/it/teoria-matematica/i-ode-you-ode-and-the-neural-ode-5/" />
<meta property="og:description" content="Dai che ci siamo. Siamo arrivati alla quinta e ultima parte della serie sulle NODE. Prendete questa affermazione con le pinze però, che se non mi basta questo spazio vi beccate anche la sesta. In ogni caso in questa (spero) ultima parte, vedremo un po&#39; di codice e di applicazione …" />
<meta property="og:site_name" content="Bit Di Vita" />
<meta property="og:article:author" content="Luca Di Vita" />
<meta property="og:article:published_time" content="2025-10-01T00:00:00+02:00" />
<meta name="twitter:title" content="Io ODO, Tu ODI e la Neural ODE - 5 ">
<meta name="twitter:description" content="Dai che ci siamo. Siamo arrivati alla quinta e ultima parte della serie sulle NODE. Prendete questa affermazione con le pinze però, che se non mi basta questo spazio vi beccate anche la sesta. In ogni caso in questa (spero) ultima parte, vedremo un po&#39; di codice e di applicazione …">

        <title>Io ODO, Tu ODI e la Neural ODE - 5  · Bit Di Vita
</title>



    </head>
    <body>
        <div id="content">
            <div class="navbar navbar-static-top">
                <div class="navbar-inner">
                    <div class="container-fluid">
                        <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </a>
                        <a class="brand" href="https://www.lucadivita.it/it/"><span class=site-name>Bit Di Vita</span></a>
                        <div class="nav-collapse collapse">
                                <ul class="nav pull-right top-menu">
                                    <li >
                                        <a href="https://www.lucadivita.it/it/index.html">Bio</a>
                                    </li>
                                    <li >
                                        <a href="https://www.lucadivita.it/it/latest.html">
                                        Recenti
                                        </a>
                                    </li>
                                    <li >
                                        <a href="https://www.lucadivita.it/it/categories.html">
                                            Argomenti
                                        </a>
                                    </li>
                                    <li >
                                        <a href="https://www.lucadivita.it/it/tags.html">
                                            Tags
                                        </a>
                                    </li>
                                    <li >
                                        <a href="https://www.lucadivita.it/it/archives.html">
                                            Archivio
                                        </a>
                                    </li>
                                            <li >
                                            </li>
                                            <li >
                                                    <a href="https://www.lucadivita.it/it/pages/contatti/">Contatti</a>
                                            </li>
                                    <li class="nav-item-separator"><a>&nbsp;</a></li>




                                        <li class="active">
                                            <a href="/it/teoria-matematica/i-ode-you-ode-and-the-neural-ode-5/">
                                                <img src="/images/flags/it.png" alt="Italian" style="horiz-align: center; vertical-align: middle; width: 2rem; ">
                                            </a>
                                        </li>



                                        <li>
                                            <a href="/en/teoria-matematica/i-ode-you-ode-and-the-neural-ode-5/">
                                                <img src="/images/flags/en.png" alt="English" style="horiz-align: center; vertical-align: middle; width: 2rem; ">
                                            </a>
                                        </li>
                                </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="container-fluid">
                <div class="row-fluid">
                    <div class="span1"></div>
                    <div class="span10">
<article itemscope>
<div class="row-fluid">
    <header class="page-header span10 offset2">
        <h1>
            <a href="https://www.lucadivita.it/it/teoria-matematica/i-ode-you-ode-and-the-neural-ode-5/">
                Io ODO, Tu ODI e la Neural ODE - 5
            </a>
        </h1>
    </header>
</div>

<div class="row-fluid">
    <div class="span2">
        <nav aria-label="Table of contents">
            <h4>Contenuti</h4>
            <div id="toc-list"></div>
        </nav>
    </div>
    <div class="span8 article-content">
            
            
<p>Dai che ci siamo. Siamo arrivati alla <strong>quinta</strong> e ultima parte della serie sulle NODE. Prendete questa affermazione con le pinze però, che se non mi basta
questo spazio vi beccate anche la sesta. In ogni caso in questa (spero) ultima parte, vedremo un po' di codice e di applicazione di una NODE.
Prima di iniziare, se siete giunti a questa pagina senza aver letto le <strong>precedenti</strong>, vi consiglio vivamente di recuperarle. <a href="#Consigliati"><strong>Qui</strong></a> trovate i link
agli articoli precedenti. Detto questo senza perdere altro tempo, iniziamo.</p>
<h3 id="dal-node-al-code">Dal NODE al Code<a class="headerlink" href="#dal-node-al-code" title="Permanent link"> </a></h3>
<p>Se c'è una cosa che abbiamo imparato (o almeno avremmo dovuto), è che di fatto le NODE si differenziano dalle reti normali non tanto a livello 
architetturale, quanto nell'<strong>utilizzo</strong> che si fa di queste architetture. In virtù di ciò, non facciamo i razzisti. Non trattiamo le NODE diversamente.
Sono in grado di fare tutto quello che fà una rete neurale classica. Si possono utilizzare per problemi di classificazione, di regressione e anche
di generazione. Va da sè che data la loro <strong>natura continua</strong>, si prestano bene per determinati use case e non per tutti. Poi, ciò non toglie che potete
utilizzare quando, come e perché volete. Non sarò di certo io a impedirvelo. Negli esempi che mostrerò le utilizzerò nel loro habitat naturale, il 
<strong>forecasting</strong>, e comparerò i risultati con quelli prodotti da una rete neurale classica.</p>
<h4 id="ancora-lotka-volterra">(Ancora) Lotka-Volterra<a class="headerlink" href="#ancora-lotka-volterra" title="Permanent link"> </a></h4>
<p>Iniziamo da questo primo use case. Supponiamo di avere una <strong>Time Series</strong>, la cui natura ci è ignota. Sappiamo solo che abbiamo numeri buttati 
in una lista. Noi sappiamo che numeri sono ma acqua in bocca, la NODE non ne ha idea di cosa <strong>rappresentano</strong>. Ecco questa lista di numeri rappresenta la nostra
base di partenza. I dati sui quali andremo ad addestrare la nostra NODE. Dato che, malauguratamente, questi dati non si <strong>generano</strong> da soli, dobbiamo 
crearli noi. Se vi state chiedendo come, niente di più semplice. Prendiamo il nostro bel modellino dinamico di <strong>Lotka-Volterra</strong> e diamolo in pasto ad un <strong>ODESolver</strong>. Se non 
sapete come è definito, recuperate la <a href="https://www.lucadivita.it/it/teoria-matematica/i-ode-you-ode-and-the-neural-ode-3/">parte 3</a>.</p>
<p>Ma basta parlare, mostriamo un po' di codice e creiamo una <strong>classe</strong> <code>LotkaVolterra</code> che estende un generico <code>DatasetProvider</code>, 
dove definiamo la <strong>dinamica</strong> del sistema e come <strong>generare</strong> i dati.</p>
<h5 id="creazione-del-dataset">Creazione Del Dataset<a class="headerlink" href="#creazione-del-dataset" title="Permanent link"> </a></h5>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="n">LotkaVolterra</span><span class="p">(</span><span class="n">DatasetProvider</span><span class="p">)</span><span class="err">:</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="nl">n_train</span><span class="p">:</span><span class="w"> </span><span class="nc">int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">80</span><span class="p">,</span><span class="w"> </span><span class="nl">noise_std</span><span class="p">:</span><span class="w"> </span><span class="nc">float</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.01</span><span class="p">,</span>
<span class="w">                 </span><span class="nl">t_train_range</span><span class="p">:</span><span class="w"> </span><span class="n">tuple</span><span class="o">[</span><span class="n">float, float</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">6.0</span><span class="p">),</span>
<span class="w">                 </span><span class="nl">t_extra_range</span><span class="p">:</span><span class="w"> </span><span class="n">tuple</span><span class="o">[</span><span class="n">float, float</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mf">6.0</span><span class="p">,</span><span class="w"> </span><span class="mf">10.0</span><span class="p">),</span>
<span class="w">                 </span><span class="nl">n_extra</span><span class="p">:</span><span class="w"> </span><span class="nc">int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">200</span><span class="p">,</span><span class="w"> </span><span class="nl">n_resamp</span><span class="p">:</span><span class="w"> </span><span class="nc">int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">200</span><span class="p">,</span>
<span class="w">                 </span><span class="nl">alpha</span><span class="p">:</span><span class="w"> </span><span class="nc">float</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.5</span><span class="p">,</span><span class="w"> </span><span class="nl">beta</span><span class="p">:</span><span class="w"> </span><span class="nc">float</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">,</span>
<span class="w">                 </span><span class="nl">delta</span><span class="p">:</span><span class="w"> </span><span class="nc">float</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.75</span><span class="p">,</span><span class="w"> </span><span class="nl">gamma</span><span class="p">:</span><span class="w"> </span><span class="nc">float</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">,</span>
<span class="w">                 </span><span class="nl">initial_values</span><span class="p">:</span><span class="w"> </span><span class="n">tuple</span><span class="o">[</span><span class="n">float, float</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mf">2.0</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">))</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">None</span><span class="err">:</span>
<span class="w">        </span><span class="n">super</span><span class="p">().</span><span class="n">__init__</span><span class="p">(</span><span class="n">initial_values</span><span class="o">=</span><span class="n">initial_values</span><span class="p">,</span><span class="w"> </span><span class="n">n_train</span><span class="o">=</span><span class="n">n_train</span><span class="p">,</span><span class="w"> </span><span class="n">noise_std</span><span class="o">=</span><span class="n">noise_std</span><span class="p">,</span>
<span class="w">                         </span><span class="n">t_train_range</span><span class="o">=</span><span class="n">t_train_range</span><span class="p">,</span><span class="w"> </span><span class="n">t_extra_range</span><span class="o">=</span><span class="n">t_extra_range</span><span class="p">,</span><span class="w"> </span><span class="n">n_extra</span><span class="o">=</span><span class="n">n_extra</span><span class="p">,</span>
<span class="w">                         </span><span class="n">n_resamp</span><span class="o">=</span><span class="n">n_resamp</span><span class="p">)</span>
<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">float</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>
<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">beta</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nc">float</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span>
<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">delta</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">float</span><span class="p">(</span><span class="n">delta</span><span class="p">)</span>
<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">gamma</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">float</span><span class="p">(</span><span class="n">gamma</span><span class="p">)</span>

<span class="w">    </span><span class="p">...</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">dynamics</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="nl">t</span><span class="p">:</span><span class="w"> </span><span class="n">torch</span><span class="p">.</span><span class="n">Tensor</span><span class="p">,</span><span class="w"> </span><span class="k">state</span><span class="err">:</span><span class="w"> </span><span class="n">torch</span><span class="p">.</span><span class="n">Tensor</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">torch</span><span class="p">.</span><span class="nl">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="n">x1</span><span class="p">,</span><span class="w"> </span><span class="n">x2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">state</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="k">state</span><span class="o">[</span><span class="n">1</span><span class="o">]</span>
<span class="w">        </span><span class="n">x1dt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">alpha</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">beta</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x2</span>
<span class="w">        </span><span class="n">x2dt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">delta</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">gamma</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x2</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">torch</span><span class="p">.</span><span class="n">stack</span><span class="p">(</span><span class="o">[</span><span class="n">x1dt, x2dt</span><span class="o">]</span><span class="p">).</span><span class="k">to</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">dtype</span><span class="p">)</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">_solve_at</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="nl">t_grid_np</span><span class="p">:</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="n">ndarray</span><span class="p">,</span><span class="w"> </span><span class="k">method</span><span class="err">:</span><span class="w"> </span><span class="nf">str</span><span class="p">,</span><span class="w"> </span><span class="nl">dynamics</span><span class="p">:</span><span class="w"> </span><span class="n">Callable</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="nl">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="p">...</span>
<span class="w">        </span><span class="n">sol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">odeint</span><span class="p">(</span><span class="n">dynamics</span><span class="p">,</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">x0_t</span><span class="p">,</span><span class="w"> </span><span class="n">t_tensor</span><span class="p">,</span><span class="w"> </span><span class="k">method</span><span class="o">=</span><span class="k">method</span><span class="p">,</span><span class="w"> </span><span class="n">rtol</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">r_tol</span><span class="p">,</span><span class="w"> </span><span class="n">atol</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">a_tol</span><span class="p">)</span>
<span class="w">        </span><span class="p">...</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">sol</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">__call__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="k">method</span><span class="err">:</span><span class="w"> </span><span class="nf">str</span><span class="p">,</span><span class="w"> </span><span class="nl">dynamics</span><span class="p">:</span><span class="w"> </span><span class="n">Callable</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nl">DataObject</span><span class="p">:</span>
<span class="w">        </span><span class="n">t_train</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="n">sort</span><span class="p">(</span><span class="n">rng</span><span class="p">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">*</span><span class="n">self</span><span class="p">.</span><span class="n">t_train_range</span><span class="p">,</span><span class="w"> </span><span class="k">size</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">n_train</span><span class="p">))</span>
<span class="w">        </span><span class="n">x_train_true</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_solve_at</span><span class="p">(</span><span class="n">t_grid_np</span><span class="o">=</span><span class="n">t_train</span><span class="p">,</span><span class="w"> </span><span class="k">method</span><span class="o">=</span><span class="k">method</span><span class="p">,</span><span class="w"> </span><span class="n">dynamics</span><span class="o">=</span><span class="n">dynamics</span><span class="p">)</span>
<span class="w">        </span><span class="n">x_train_noised</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x_train_true</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">noise_std</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">rng</span><span class="p">.</span><span class="n">standard_normal</span><span class="p">(</span><span class="n">x_train_true</span><span class="p">.</span><span class="n">shape</span><span class="p">)</span>

<span class="w">        </span><span class="n">t_test_extra</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">*</span><span class="n">self</span><span class="p">.</span><span class="n">t_extra_range</span><span class="p">,</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">n_extra</span><span class="p">)</span>
<span class="w">        </span><span class="n">x_test_extra_true</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_solve_at</span><span class="p">(</span><span class="n">t_grid_np</span><span class="o">=</span><span class="n">t_test_extra</span><span class="p">,</span><span class="w"> </span><span class="k">method</span><span class="o">=</span><span class="k">method</span><span class="p">,</span><span class="w"> </span><span class="n">dynamics</span><span class="o">=</span><span class="n">dynamics</span><span class="p">)</span>

<span class="w">        </span><span class="n">t_test_resamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="n">sort</span><span class="p">(</span><span class="n">rng</span><span class="p">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">*</span><span class="n">self</span><span class="p">.</span><span class="n">t_train_range</span><span class="p">,</span><span class="w"> </span><span class="k">size</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">n_resamp</span><span class="p">))</span>
<span class="w">        </span><span class="n">x_test_resamp_true</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_solve_at</span><span class="p">(</span><span class="n">t_grid_np</span><span class="o">=</span><span class="n">t_test_resamp</span><span class="p">,</span><span class="w"> </span><span class="k">method</span><span class="o">=</span><span class="k">method</span><span class="p">,</span><span class="w"> </span><span class="n">dynamics</span><span class="o">=</span><span class="n">dynamics</span><span class="p">)</span>
<span class="w">        </span><span class="n">x_test_resamp_noised</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x_test_resamp_true</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">noise_std</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">rng</span><span class="p">.</span><span class="n">standard_normal</span><span class="p">(</span><span class="n">x_test_resamp_true</span><span class="p">.</span><span class="n">shape</span><span class="p">)</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_create_dict</span><span class="p">(</span><span class="n">t_train</span><span class="p">,</span><span class="w"> </span><span class="n">x_train_noised</span><span class="p">,</span><span class="w"> </span><span class="n">x_train_true</span><span class="p">,</span><span class="w"> </span><span class="n">t_test_extra</span><span class="p">,</span><span class="w"> </span><span class="n">x_test_extra_true</span><span class="p">,</span><span class="w"> </span><span class="n">t_test_resamp</span><span class="p">,</span><span class="w"> </span><span class="n">x_test_resamp_true</span><span class="p">,</span><span class="w"> </span><span class="n">x_test_resamp_noised</span><span class="p">)</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">prepare_data</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="k">data</span><span class="err">:</span><span class="w"> </span><span class="n">DataObject</span><span class="p">,</span><span class="w"> </span><span class="nl">shuffle</span><span class="p">:</span><span class="w"> </span><span class="n">bool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">True</span><span class="p">,</span><span class="w"> </span><span class="nl">use_noise</span><span class="p">:</span><span class="w"> </span><span class="n">bool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">True</span><span class="p">,</span><span class="w"> </span><span class="nl">train_K_max</span><span class="p">:</span><span class="w"> </span><span class="n">Optional</span><span class="o">[</span><span class="n">int</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">None</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nl">Loaders</span><span class="p">:</span>
<span class="w">        </span><span class="k">out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">{}</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">train_K_max</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">None</span><span class="err">:</span>
<span class="w">            </span><span class="n">ds_train</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_build_pairwise_transitions</span><span class="p">(</span><span class="k">data</span><span class="o">[</span><span class="n">"t_train"</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="k">data</span><span class="o">[</span><span class="n">"x_train_noised" if use_noise else "x_train_true"</span><span class="o">]</span><span class="p">,</span>
<span class="w">                                                        </span><span class="k">data</span><span class="o">[</span><span class="n">"x_train_true"</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="w">        </span><span class="k">else</span><span class="err">:</span>
<span class="w">            </span><span class="n">ds_train</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_build_multi_horizon_transitions</span><span class="p">(</span><span class="k">data</span><span class="o">[</span><span class="n">"t_train"</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="k">data</span><span class="o">[</span><span class="n">"x_train_noised" if use_noise else "x_train_true"</span><span class="o">]</span><span class="p">,</span>
<span class="w">                                                             </span><span class="k">data</span><span class="o">[</span><span class="n">"x_train_true"</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">K_max</span><span class="o">=</span><span class="n">train_K_max</span><span class="p">,</span><span class="w"> </span><span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="w">        </span><span class="k">out</span><span class="o">[</span><span class="n">"train"</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">{</span><span class="ss">"dataset"</span><span class="err">:</span><span class="w"> </span><span class="n">DataLoader</span><span class="p">(</span><span class="n">ds_train</span><span class="p">,</span><span class="w"> </span><span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span><span class="w"> </span><span class="n">shuffle</span><span class="o">=</span><span class="n">shuffle</span><span class="p">)</span><span class="err">}</span>

<span class="w">        </span><span class="n">ds_resamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_build_pairwise_transitions</span><span class="p">(</span><span class="k">data</span><span class="o">[</span><span class="n">"t_test_resamp"</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="k">data</span><span class="o">[</span><span class="n">"x_test_resamp_noised" if use_noise else "x_test_resamp_true"</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="k">data</span><span class="o">[</span><span class="n">"x_test_resamp_true"</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="w">        </span><span class="k">out</span><span class="o">[</span><span class="n">"resamp"</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">{</span><span class="ss">"dataset"</span><span class="err">:</span><span class="w"> </span><span class="n">DataLoader</span><span class="p">(</span><span class="n">ds_resamp</span><span class="p">,</span><span class="w"> </span><span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span><span class="w"> </span><span class="n">shuffle</span><span class="o">=</span><span class="k">False</span><span class="p">)</span><span class="err">}</span>

<span class="w">        </span><span class="n">ds_extra</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_build_pairwise_transitions</span><span class="p">(</span><span class="k">data</span><span class="o">[</span><span class="n">"t_test_extra"</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="k">data</span><span class="o">[</span><span class="n">"x_test_extra_true"</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="k">data</span><span class="o">[</span><span class="n">"x_test_extra_true"</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="w">        </span><span class="k">out</span><span class="o">[</span><span class="n">"extra"</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">{</span><span class="ss">"dataset"</span><span class="err">:</span><span class="w"> </span><span class="n">DataLoader</span><span class="p">(</span><span class="n">ds_extra</span><span class="p">,</span><span class="w"> </span><span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span><span class="w"> </span><span class="n">shuffle</span><span class="o">=</span><span class="k">False</span><span class="p">)</span><span class="err">}</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">out</span>
</code></pre></div>
<p>Si lo sò, è tanto <strong>codice</strong>. Ma lasciate che ve lo spieghi. Nel costruttore, oltre a passare i <strong>parametri</strong> necessari alla definizione del <strong>sistema</strong>, forniamo 
anche informazioni relative a come vogliamo che venga costruito il nostro <strong>dataset</strong>:</p>
<ul>
<li><code>t_train_range</code>: Rappresenta il <strong>range temporale</strong> nel quale vogliamo che siano presi i campioni di train e di test.</li>
<li><code>n_train</code>: Indica il <strong>numero di campioni di train</strong> che vogliamo generare.</li>
<li><code>n_resamp</code>: Indica il <strong>numero di campioni di test</strong> che vogliamo generare.</li>
<li><code>noise_std</code>: Serve a <strong>sporcare</strong> i dati di train e di test. Perché che vita sarebbe senza un po' di difficoltà?</li>
<li><code>t_extra_range</code>: Rappresenta il range temporale del quale vogliamo fare <strong>forecast</strong>.</li>
<li><code>n_extra</code>: Indica il numero di campioni che si vogliono prevedere nel range di forecast.</li>
</ul>
<p>Quindi se consideriamo le seguenti righe:</p>
<div class="highlight"><pre><span></span><code>DataCreator = LotkaVolterra
params = {
    "n_train": 350,
    "noise_std": 0.01,
    "t_train_range": (0.0, 12.0),
    "t_extra_range": (12.0, 18.0),
    "n_extra": 300,
    "n_resamp": 200,
}
data_creator = DataCreator(**params)
data = data_creator.prepare_data(data)
</code></pre></div>
<p>quello che stiamo chiedendo è di avere un dataset composto da:</p>
<ul>
<li><span class="math">\(350\)</span> samples di train campionati <strong>casualmente</strong> nel range temporale <span class="math">\((0, 12)\)</span> secondi, ed i relativi <strong>istanti temporali</strong>.</li>
<li><span class="math">\(200\)</span> samples di test campionati <strong>casualmente</strong> nel range temporale <span class="math">\((0, 12)\)</span> secondi, ed i relativi <strong>istanti temporali</strong>.</li>
<li><span class="math">\(300\)</span> samples di <strong>forecast</strong> nel range <span class="math">\((12, 18)\)</span> secondi (utilizzati solo per verificare se le predizioni sono corrette), ed i relativi <strong>istanti temporali</strong>.</li>
</ul>
<p>Questi dataset sono strutturati in questo modo:</p>
<div class="highlight"><pre><span></span><code>idx   t_i      x_i                  t_next   x_next               dt      
--------------------------------------------------------------------------------
0     0.023    [ 1.986 -0.044]      0.118    [ 1.986 -0.235]      0.095   
1     0.118    [ 1.968 -0.245]      0.159    [ 1.975 -0.314]      0.041   
2     0.159    [ 1.986 -0.314]      0.160    [ 1.975 -0.317]      0.001   
3     0.160    [ 1.971 -0.318]      0.200    [ 1.96  -0.394]      0.040   
4     0.200    [ 1.988 -0.383]      0.211    [ 1.956 -0.415]      0.011   
5     0.211    [ 1.948 -0.398]      0.306    [ 1.908 -0.593]      0.094 
<span class="k">...</span>   ...      ...                  ...      ...                  ...
</code></pre></div>
<p>dove:</p>
<ul>
<li><span class="math">\(t_i\)</span>: E' <strong>l'attuale</strong> istante temporale.</li>
<li><span class="math">\(x_i\)</span>: E' lo stato nell'istante <strong>attuale</strong>, calcolato sia con l'aggiunta di <strong>rumore</strong> che senza, nel caso di <code>train</code> e <code>test</code>.</li>
<li><span class="math">\(t_{next}\)</span>: E' l'istante temporale <strong>successivo</strong>.</li>
<li><span class="math">\(x_{next}\)</span>: E' lo <strong>stato</strong> nell'istante temporale successivo. Nel caso di <code>train</code>, lo stato è il valore a <span class="math">\(K\)</span> <strong>passi di distanza</strong>, con <span class="math">\(K\)</span> intero casuale.</li>
<li><span class="math">\(dt\)</span>: E' il <strong>delta</strong> trascorso dai due istanti temporali.</li>
</ul>
<p>Facendo il plot di questi dati otteniamo l'immagine che segue:</p>
<p class="image-caption"><img alt="TrueData" class="image" src="https://www.lucadivita.it/it/images/teoria_matematica/neural_ode_5/dataset_LotkaVolterra_train.svg"/>
Figura 1. Dataset di Train Vero e Rumoroso</p>
<p>Se vi steste chiedendo come, di fatto, risolviamo la dinamica, lo facciamo tramite il metodo <code>odeint</code> definito dalla libreria <a href="https://github.com/rtqichen/torchdiffeq"><strong>torchdiffeq</strong></a>,
che fornisce metodi di <strong>alto livello</strong> per la gestione delle NODE. Questo metodo implementa vari ODESolver, 
e nel nostro caso è stato utilizzato <a href="https://en.wikipedia.org/wiki/Dormand%E2%80%93Prince_method"><strong>dopri5</strong></a></p>
<h5 id="definizione-delle-reti">Definizione Delle Reti<a class="headerlink" href="#definizione-delle-reti" title="Permanent link"> </a></h5>
<p>Dato che l'obiettivo principale è comparare i risultati a <strong>parità di condizioni</strong>, si sono utilizzate due reti quasi identiche. Andiamo a vedere perché sono <em>quasi identiche</em>
e non <em>identiche</em>.</p>
<div class="highlight"><pre><span></span><code><span class="nx">def</span><span class="w"> </span><span class="nx">lotka_volterra_nets</span><span class="p">():</span>

<span class="w">    </span><span class="nx">def</span><span class="w"> </span><span class="nx">create_net</span><span class="p">(</span><span class="nx">is_node</span><span class="p">:</span><span class="w"> </span><span class="kt">bool</span><span class="p">):</span>
<span class="w">        </span><span class="nx">input_dim</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">LotkaVolterra</span><span class="p">.</span><span class="nx">get_dim</span><span class="p">()</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nx">is_node</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="nx">LotkaVolterra</span><span class="p">.</span><span class="nx">get_dim</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">nn</span><span class="p">.</span><span class="nx">Sequential</span><span class="p">(</span>
<span class="w">                </span><span class="nx">torch</span><span class="p">.</span><span class="nx">nn</span><span class="p">.</span><span class="nx">Linear</span><span class="p">(</span><span class="nx">input_dim</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">),</span>
<span class="w">                </span><span class="nx">torch</span><span class="p">.</span><span class="nx">nn</span><span class="p">.</span><span class="nx">Tanh</span><span class="p">(),</span>
<span class="w">                </span><span class="nx">torch</span><span class="p">.</span><span class="nx">nn</span><span class="p">.</span><span class="nx">Linear</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">),</span>
<span class="w">                </span><span class="nx">torch</span><span class="p">.</span><span class="nx">nn</span><span class="p">.</span><span class="nx">Tanh</span><span class="p">(),</span>
<span class="w">                </span><span class="nx">torch</span><span class="p">.</span><span class="nx">nn</span><span class="p">.</span><span class="nx">Linear</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="nx">LotkaVolterra</span><span class="p">.</span><span class="nx">get_dim</span><span class="p">()),</span>
<span class="w">            </span><span class="p">)</span>

<span class="w">    </span><span class="kd">class</span><span class="w"> </span><span class="nx">SimpleNet</span><span class="p">(</span><span class="nx">nn</span><span class="p">.</span><span class="nx">Module</span><span class="p">):</span>

<span class="w">        </span><span class="nx">def</span><span class="w"> </span><span class="nx">__init__</span><span class="p">(</span><span class="kp">self</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="nx">args</span><span class="p">,</span><span class="w"> </span><span class="o">**</span><span class="nx">kwargs</span><span class="p">):</span>
<span class="w">            </span><span class="nx">super</span><span class="p">().</span><span class="nx">__init__</span><span class="p">(</span><span class="o">*</span><span class="nx">args</span><span class="p">,</span><span class="w"> </span><span class="o">**</span><span class="nx">kwargs</span><span class="p">)</span>
<span class="w">            </span><span class="kp">self</span><span class="p">.</span><span class="nx">ann</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">create_net</span><span class="p">(</span><span class="nx">is_node</span><span class="p">=</span><span class="nx">False</span><span class="p">)</span>
<span class="w">            </span><span class="kp">self</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">LotkaVolterra</span><span class="p">.</span><span class="nx">get_name</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">"_MLP"</span>

<span class="w">        </span><span class="nx">def</span><span class="w"> </span><span class="nx">forward</span><span class="p">(</span><span class="kp">self</span><span class="p">,</span><span class="w"> </span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="nx">dt</span><span class="p">):</span>
<span class="w">            </span><span class="nx">z</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">torch</span><span class="p">.</span><span class="nx">cat</span><span class="p">([</span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="nx">dt</span><span class="p">],</span><span class="w"> </span><span class="nx">dim</span><span class="p">=</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kp">self</span><span class="p">.</span><span class="nx">ann</span><span class="p">(</span><span class="nx">z</span><span class="p">)</span>

<span class="w">    </span><span class="kd">class</span><span class="w"> </span><span class="nx">NODE</span><span class="p">(</span><span class="nx">nn</span><span class="p">.</span><span class="nx">Module</span><span class="p">):</span>

<span class="w">        </span><span class="nx">def</span><span class="w"> </span><span class="nx">__init__</span><span class="p">(</span><span class="kp">self</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="nx">args</span><span class="p">,</span><span class="w"> </span><span class="o">**</span><span class="nx">kwargs</span><span class="p">):</span>
<span class="w">            </span><span class="nx">super</span><span class="p">().</span><span class="nx">__init__</span><span class="p">(</span><span class="o">*</span><span class="nx">args</span><span class="p">,</span><span class="w"> </span><span class="o">**</span><span class="nx">kwargs</span><span class="p">)</span>
<span class="w">            </span><span class="kp">self</span><span class="p">.</span><span class="nx">ann</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">create_net</span><span class="p">(</span><span class="nx">is_node</span><span class="p">=</span><span class="nx">True</span><span class="p">)</span>
<span class="w">            </span><span class="kp">self</span><span class="p">.</span><span class="nx">method</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">LotkaVolterra</span><span class="p">.</span><span class="nx">get_method</span><span class="p">()</span>
<span class="w">            </span><span class="kp">self</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">LotkaVolterra</span><span class="p">.</span><span class="nx">get_name</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">"_NODE"</span>
<span class="w">            </span><span class="kp">self</span><span class="p">.</span><span class="nx">h</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="m m-Double">0.01</span>

<span class="w">        </span><span class="nx">def</span><span class="w"> </span><span class="nx">forward</span><span class="p">(</span><span class="kp">self</span><span class="p">,</span><span class="w"> </span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="p">):</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kp">self</span><span class="p">.</span><span class="nx">ann</span><span class="p">(</span><span class="nx">state</span><span class="p">)</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">SimpleNet</span><span class="p">(),</span><span class="w"> </span><span class="nx">NODE</span><span class="p">()</span>
</code></pre></div>
<p>Mentre per le NODE, l'utilizzo del tempo <span class="math">\(t\)</span> è <strong>implicito</strong> nella loro natura, questo non è vero per le reti classiche.
Quindi per queste ultime, dobbiamo considerare esplicitamente il fattore tempo e lo facciamo considerandolo come <strong>feature aggiuntiva</strong>. Per via di ciò la rete neurale classica, che chiamiamo 
<code>SimpleNet</code> ha una dimensione in più in input. </p>
<p>La <code>NODE</code> invece, accetta il parametro <span class="math">\(t\)</span> in fase di forward ma viene utilizzato per il calcolo della <strong>dinamica</strong> e non
come feature in maniera diretta. Quindi è <strong>necessario</strong> passarlo, ma non incide sul numero di <strong>neuroni</strong>, che rimangono pari al numero di <strong>variabili</strong> del problema. Avendo quindi
due architetture quasi uguali ma non identiche, mi sono dovuto accontentare di avere due <strong>inizializzazioni</strong> diverse dei pesi, ahimè non si può avere tutto nella vita. Ma almeno la 
salute c'è (per ora). Ultima nota. No non sono impazzito, se ho utilizzato le <code>Tanh</code> come funzioni di <strong>attivazione</strong> è perché <code>torchdiffeq</code> <a href="https://github.com/rtqichen/torchdiffeq/blob/master/FAQ.md"><strong>specifica</strong> di evitare</a> 
l'utilizzo di attivazioni non smooth. </p>
<p>Ora che abbiamo due modelli pronti e un dataset su cui metterli alla prova, passiamo finalmente all’<strong>addestramento</strong>.</p>
<h5 id="addestramento">Addestramento<a class="headerlink" href="#addestramento" title="Permanent link"> </a></h5>
<p>Essendo le reti di <strong>natura</strong> diversa, lo sarà anche il train. Ad alto livello neanche troppo a dire la verità ma a basso livello beh...leggetevi la <a href="https://www.lucadivita.it/it/teoria-matematica/i-ode-you-ode-and-the-neural-ode-4/">quarta parte</a> 
e la serie di articoli sui <a href="https://www.lucadivita.it/it/machine-learning/neurons-for-dummies-1/">neuroni</a> per capire quanto in realtà siano profondamente diversi. Dato che, fortunatamente,
qualcuno ha già smazzato il lavoro sporco per noi, questa differenza ad <strong>alto livello</strong> si nota ben poco. Andiamola a vedere:</p>
<div class="highlight"><pre><span></span><code><span class="n">def</span><span class="w"> </span><span class="n">train_mlp</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">train_loader</span><span class="p">,</span><span class="w"> </span><span class="n">resamp_loader</span><span class="p">)</span><span class="err">:</span>
<span class="w">    </span><span class="p">...</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="k">range</span><span class="p">(</span><span class="n">start_epoch</span><span class="p">,</span><span class="w"> </span><span class="n">start_epoch</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">epochs</span><span class="p">)</span><span class="err">:</span>
<span class="w">        </span><span class="n">model</span><span class="p">.</span><span class="n">train</span><span class="p">()</span>
<span class="w">        </span><span class="n">epoch_loss</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">x_i</span><span class="p">,</span><span class="w"> </span><span class="n">x_next</span><span class="p">,</span><span class="w"> </span><span class="n">dt</span><span class="p">,</span><span class="w"> </span><span class="n">t_i</span><span class="p">,</span><span class="w"> </span><span class="n">t_next</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nl">train_loader</span><span class="p">:</span>
<span class="w">            </span><span class="n">opt</span><span class="p">.</span><span class="n">zero_grad</span><span class="p">()</span>
<span class="w">            </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">model</span><span class="p">(</span><span class="n">x_i</span><span class="p">,</span><span class="w"> </span><span class="n">dt</span><span class="p">)</span>
<span class="w">            </span><span class="n">loss</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">crit</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">x_next</span><span class="p">)</span>
<span class="w">            </span><span class="n">loss</span><span class="p">.</span><span class="n">backward</span><span class="p">()</span>
<span class="w">            </span><span class="n">opt</span><span class="p">.</span><span class="n">step</span><span class="p">()</span>
<span class="w">            </span><span class="n">epoch_loss</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">loss</span><span class="p">.</span><span class="n">item</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">x_i</span><span class="p">.</span><span class="n">shape</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">x_i</span><span class="p">.</span><span class="n">ndim</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>

<span class="w">        </span><span class="n">train_avg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">epoch_loss</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nf">len</span><span class="p">(</span><span class="n">train_loader</span><span class="p">.</span><span class="n">dataset</span><span class="p">)</span>
<span class="w">        </span><span class="n">val_avg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">eval_mlp</span><span class="p">(</span><span class="n">loader</span><span class="o">=</span><span class="n">resamp_loader</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">)</span>
<span class="w">        </span><span class="p">...</span>

<span class="n">def</span><span class="w"> </span><span class="n">train_node</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">train_loader</span><span class="p">,</span><span class="w"> </span><span class="n">resamp_loader</span><span class="p">)</span><span class="err">:</span>
<span class="w">    </span><span class="p">...</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">epoch</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="k">range</span><span class="p">(</span><span class="n">start_epoch</span><span class="p">,</span><span class="w"> </span><span class="n">start_epoch</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">epochs</span><span class="p">)</span><span class="err">:</span>
<span class="w">        </span><span class="n">model</span><span class="p">.</span><span class="n">train</span><span class="p">()</span>
<span class="w">        </span><span class="n">epoch_loss</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">x_i</span><span class="p">,</span><span class="w"> </span><span class="n">x_next</span><span class="p">,</span><span class="w"> </span><span class="n">_dt</span><span class="p">,</span><span class="w"> </span><span class="n">t_i</span><span class="p">,</span><span class="w"> </span><span class="n">t_next</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nl">train_loader</span><span class="p">:</span>
<span class="w">            </span><span class="n">opt</span><span class="p">.</span><span class="n">zero_grad</span><span class="p">()</span>
<span class="w">            </span><span class="n">preds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">[]</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="k">range</span><span class="p">(</span><span class="n">x_i</span><span class="p">.</span><span class="k">size</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="err">:</span>
<span class="w">                </span><span class="n">tspan</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">torch</span><span class="p">.</span><span class="n">stack</span><span class="p">((</span><span class="n">t_i</span><span class="o">[</span><span class="n">j</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">t_next</span><span class="o">[</span><span class="n">j</span><span class="o">]</span><span class="p">)).</span><span class="k">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">x_i</span><span class="p">.</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">dtype</span><span class="o">=</span><span class="n">x_i</span><span class="p">.</span><span class="n">dtype</span><span class="p">)</span>
<span class="w">                </span><span class="n">x_T</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">odeint</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">x_i</span><span class="o">[</span><span class="n">j</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">tspan</span><span class="p">)</span><span class="o">[</span><span class="n">-1</span><span class="o">]</span>
<span class="w">                </span><span class="n">preds</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">x_T</span><span class="p">)</span>
<span class="w">            </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">torch</span><span class="p">.</span><span class="n">stack</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">            </span><span class="n">loss</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">crit</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">x_next</span><span class="p">)</span>
<span class="w">            </span><span class="n">loss</span><span class="p">.</span><span class="n">backward</span><span class="p">()</span>
<span class="w">            </span><span class="n">opt</span><span class="p">.</span><span class="n">step</span><span class="p">()</span>
<span class="w">            </span><span class="n">epoch_loss</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">loss</span><span class="p">.</span><span class="n">item</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">x_i</span><span class="p">.</span><span class="n">shape</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">x_i</span><span class="p">.</span><span class="n">ndim</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>

<span class="w">        </span><span class="n">train_avg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">epoch_loss</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nf">len</span><span class="p">(</span><span class="n">train_loader</span><span class="p">.</span><span class="n">dataset</span><span class="p">)</span>
<span class="w">        </span><span class="n">val_avg</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">eval_node</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">loader</span><span class="o">=</span><span class="n">resamp_loader</span><span class="p">)</span>
<span class="w">        </span><span class="p">...</span>
</code></pre></div>
<p>Come si può vedere, quando andiamo ad addestrare <code>SimpleNet</code> attraverso la funzione <code>train_mlp</code>, forniamo i dati in <strong>batch</strong>. Questo perché nel suo utilizzo classico, la rete neurale può gestirlo. Per cui quello che facciamo 
è fornire in batch, alla rete, delle coppie <span class="math">\((x_i, dt)\)</span>. La generica predizione <span class="math">\(y\)</span> della rete, ottenuta per ogni coppia, rappresenta quanto <strong>varrà</strong> lo stato di input <span class="math">\(x_i\)</span>, 
trascorsi <span class="math">\(dt\)</span> secondi. La loss, che è una <a href="https://docs.pytorch.org/docs/stable/generated/torch.nn.MSELoss.html"><strong>MSE</strong></a>, viene calcolata usando lo <strong>stato predetto</strong> <span class="math">\(y\)</span> e lo <strong>stato di arrivo</strong> vero <span class="math">\(x_{next}\)</span>.</p>
<p>Per quanto riguarda <code>NODE</code> invece, come si può vedere, usa al suo interno il <strong>metodo</strong> <code>odeint</code> ma questa volta non forniamo una ODE rappresentante la dinamica, bensì la <strong>rete neurale</strong>
stessa, e lo scopo è far si che <strong>impari</strong> la dinamica a partire dai dati, e quindi fare la <strong>corretta previsione di come evolverà il sistema</strong>. Mentre nelle <code>SimpleNet</code> la differenza temporale era fornita 
e quindi si possono gestire i batch, qui questo concetto <strong>viene meno</strong>. Questo perché il tempo è <strong>implicito</strong> nelle NODE come detto, ma <code>odeint</code> lavora con <strong>un solo range temporale</strong> la volta, mentre
per ogni <span class="math">\(x_i\)</span> del dataset, il <span class="math">\(dt\)</span> cambia. Quindi quello che avviene <strong>ciclicamente</strong> nel train è questo:</p>
<ol>
<li>Prendiamo lo stato <span class="math">\(x_i\)</span> come <strong>stato iniziale</strong>.</li>
<li>Prendiamo <strong>l'istante temporale</strong> <span class="math">\(t_i\)</span> associato allo stato <span class="math">\(x_i\)</span>.</li>
<li>Prendiamo <strong>l'istante finale</strong> <span class="math">\(t_next\)</span> associato allo stato finale <span class="math">\(x_next\)</span>.</li>
<li><strong>Integriamo</strong> tramite un ODESolver la dinamica <span class="math">\(f\)</span> rappresentata dalla rete <code>NODE</code> dall'istante iniziale <span class="math">\(t_i\)</span> a quello finale <span class="math">\(t_next\)</span>, con condizione iniziale <span class="math">\(x_i\)</span>.</li>
<li>Prendiamo lo <strong>stato finale</strong> <span class="math">\(x_T\)</span> che rappresenta il valore predetto.</li>
</ol>
<p>Questi passaggi avvengono per tutti i campioni del dataset e, una volta completato il ciclo, calcoliamo la loss MSE usando <strong>stati predetti</strong> <span class="math">\(x_T\)</span> e <strong>stati veri</strong> <span class="math">\(x_{next}\)</span>. 
Addestrando le reti con <span class="math">\(100\)</span> epoche, l'output di questa fase è qualcosa del tipo:</p>
<div class="highlight"><pre><span></span><code><span class="n">Loading</span><span class="w"> </span><span class="n">Dataset</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">LotkaVolterra</span>
<span class="o">[</span><span class="n">ckpt</span><span class="o">]</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">best</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="n">epoch</span><span class="w"> </span><span class="mi">0</span><span class="err">:</span><span class="w"> </span><span class="n">train</span><span class="o">=</span><span class="mf">3.042975</span><span class="p">,</span><span class="w"> </span><span class="n">resamp</span><span class="o">=</span><span class="mf">2.176756</span>
<span class="n">Epoch</span><span class="w"> </span><span class="mi">000</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">train</span><span class="w"> </span><span class="mf">3.042975</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">resamp</span><span class="w"> </span><span class="mf">2.176756</span>
<span class="o">[</span><span class="n">ckpt</span><span class="o">]</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">best</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="n">epoch</span><span class="w"> </span><span class="mi">1</span><span class="err">:</span><span class="w"> </span><span class="n">train</span><span class="o">=</span><span class="mf">1.603393</span><span class="p">,</span><span class="w"> </span><span class="n">resamp</span><span class="o">=</span><span class="mf">1.257801</span>
<span class="n">Epoch</span><span class="w"> </span><span class="mi">001</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">train</span><span class="w"> </span><span class="mf">1.603393</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">resamp</span><span class="w"> </span><span class="mf">1.257801</span>
<span class="o">[</span><span class="n">ckpt</span><span class="o">]</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">best</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="n">epoch</span><span class="w"> </span><span class="mi">2</span><span class="err">:</span><span class="w"> </span><span class="n">train</span><span class="o">=</span><span class="mf">0.689440</span><span class="p">,</span><span class="w"> </span><span class="n">resamp</span><span class="o">=</span><span class="mf">0.469525</span>
<span class="n">Epoch</span><span class="w"> </span><span class="mi">002</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">train</span><span class="w"> </span><span class="mf">0.689440</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">resamp</span><span class="w"> </span><span class="mf">0.469525</span>
<span class="p">...</span>
<span class="n">Epoch</span><span class="w"> </span><span class="mi">099</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">train</span><span class="w"> </span><span class="mf">0.003902</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">resamp</span><span class="w"> </span><span class="mf">8.248611</span>
<span class="n">MLP</span><span class="w"> </span><span class="n">Train</span><span class="w"> </span><span class="n">Done</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="mf">31.057</span><span class="n">s</span>
<span class="p">...</span>
<span class="o">[</span><span class="n">ckpt</span><span class="o">]</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">best</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="n">epoch</span><span class="w"> </span><span class="mi">0</span><span class="err">:</span><span class="w"> </span><span class="n">train</span><span class="o">=</span><span class="mf">0.007876</span><span class="p">,</span><span class="w"> </span><span class="n">resamp</span><span class="o">=</span><span class="mf">0.563527</span>
<span class="n">Epoch</span><span class="w"> </span><span class="mi">000</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">train</span><span class="w"> </span><span class="mf">0.007876</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">resamp</span><span class="w"> </span><span class="mf">0.563527</span>
<span class="o">[</span><span class="n">ckpt</span><span class="o">]</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">best</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="n">epoch</span><span class="w"> </span><span class="mi">1</span><span class="err">:</span><span class="w"> </span><span class="n">train</span><span class="o">=</span><span class="mf">0.007059</span><span class="p">,</span><span class="w"> </span><span class="n">resamp</span><span class="o">=</span><span class="mf">0.510813</span>
<span class="n">Epoch</span><span class="w"> </span><span class="mi">001</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">train</span><span class="w"> </span><span class="mf">0.007059</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">resamp</span><span class="w"> </span><span class="mf">0.510813</span>
<span class="n">Epoch</span><span class="w"> </span><span class="mi">002</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">train</span><span class="w"> </span><span class="mf">0.006362</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">resamp</span><span class="w"> </span><span class="mf">0.537184</span>
<span class="p">...</span>
<span class="n">Epoch</span><span class="w"> </span><span class="mi">099</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">train</span><span class="w"> </span><span class="mf">0.000170</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">resamp</span><span class="w"> </span><span class="mf">0.038154</span>
<span class="n">NODE</span><span class="w"> </span><span class="n">Train</span><span class="w"> </span><span class="n">Done</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="mf">512.356</span><span class="n">s</span>
</code></pre></div>
<p>Notiamo subito che la NODE ci ha messo non tanto, ma <strong>tantissimo</strong> di più rispetto la rete tradizionale. Se vi steste chiedendo il perché beh, non avete letto la 
<a href="https://www.lucadivita.it/it/teoria-matematica/i-ode-you-ode-and-the-neural-ode-4/">quarta parte</a>. Ma non fermiamoci solo ai numeri e vediamo con i <strong>nostri
occhi</strong> come è andato il train. Ecco il risultato visivo del <strong>processo di addestramento</strong> per entrambi i modelli, riprodotto in tempo reale:</p>
<p class="image-caption"><img alt="LVMLP" class="image" src="https://www.lucadivita.it/it/images/teoria_matematica/neural_ode_5/lv_mlp.gif"/>
Figura 2. Addestramento su Lotka-Volterra di <code>SimpleNet</code></p>
<p class="image-caption"><img alt="LVNODE" class="image" src="https://www.lucadivita.it/it/images/teoria_matematica/neural_ode_5/lv_node.gif"/>
Figura 3. Addestramento su Lotka-Volterra di <code>NODE</code></p>
<p>Già da queste gif, si può vedere che con sole <span class="math">\(100\)</span> epoche, la <code>NODE</code> sembra aver <strong>capito la dinamica</strong> molto meglio della <code>SimpleNet</code>.
Ma addestrare non basta. Vediamo ora come si comportano questi modelli quando li mettiamo alla prova <strong>fuori</strong> dal range di training.</p>
<h5 id="forecast">Forecast<a class="headerlink" href="#forecast" title="Permanent link"> </a></h5>
<p>Nella fase di train abbiamo insegnato, o almeno ci abbiamo provato, alle reti <code>NODE</code> e <code>SimpleNet</code> a seguire l'andamento di un sistema dinamico. 
Ok si, era il Lotka-Volterra, ma questo le reti non lo sanno. Quello che hanno visto è stato solamente una lista di valori <strong>campionati a caso</strong> nel tempo. 
Ma come facciamo a verificare se effettivamente hanno <strong>capito</strong>? Per quel che ne sappiamo, potrebbero aver imparato benissimo il <code>train</code> e <code>test</code> set, 
ma senza essere in grado di <strong>generalizzare</strong>. Quello che vogliamo è verificare che:</p>
<blockquote>
<p>Dati i campioni da <span class="math">\((0, \, 12)\)</span> secondi, riesco a prevedere l'andamento da <span class="math">\(12\)</span> secondi in poi?</p>
</blockquote>
<p>Per fare questo dobbiamo procedere in due modi <strong>differenti</strong> per <code>SimpleNet</code> e <code>NODE</code>. Questo perché mentre la <em>predizione in avanti</em> é implicita nelle NODE, non lo é per 
le reti classiche. Per <code>SimpleNet</code> quindi, utilizziamo un approccio <strong>autoregressivo</strong>, cioé si sfrutta lo stato predetto come input per <strong>quantificare</strong> lo stato successivo.
Andiamo a vedere in codice cosa significa:</p>
<div class="highlight"><pre><span></span><code><span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">predict_mlp</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">loader</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
    <span class="o">...</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x_i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">t_grid</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">t_grid</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">t_grid</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>
        <span class="n">traj</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">traj</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="o">...</span>
    <span class="k">return</span> <span class="n">pred</span><span class="p">,</span> <span class="n">tgt</span>

<span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">predict_node</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">loader</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
    <span class="o">...</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="n">x_i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">traj</span> <span class="o">=</span> <span class="n">odeint</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">t_grid</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">method</span><span class="p">)</span>
    <span class="o">...</span>
    <span class="k">return</span> <span class="n">traj</span><span class="p">,</span> <span class="n">tgt</span>
</code></pre></div>
<p>Nella funzione <code>predict_mlp</code>, utilizzata per fare le <strong>predizioni</strong> tramite <code>SimpleNet</code>, prendiamo un valore di partenza che può essere lo stato <span class="math">\(x\)</span> in <span class="math">\(t=12\)</span> secondi. Facciamo
la predizione usando come <strong>input</strong> <span class="math">\(x\)</span> e andando in <strong>avanti</strong> di un tempo <span class="math">\(dt\)</span>. L'output, cioé lo stato al tempo <span class="math">\(dt\)</span>, viene utilizzato come <strong>input</strong> per fare la predizione dello 
stato successivo al <span class="math">\(dt\)</span> <strong>successivo</strong>. Dato che noi vogliamo fare predizioni nel range <span class="math">\((12, 18)\)</span> secondi, questo ciclo continua fino ad arrivare a <span class="math">\(t=18\)</span>. Questo tipo di predizione iterativa però è 
<strong>fragile</strong>: ogni errore si <strong>propaga nel tempo</strong>, rendendo più difficile una buona <strong>generalizzazione</strong>. </p>
<p>Per quanto riguarda la <code>NODE</code> invece, ci semplifica di molto le cose dato che proprio per la sua natura, quando andiamo a <strong>integrare</strong> da <span class="math">\(12\)</span> a <span class="math">\(18\)</span> secondi, stiamo calcolando la
<strong>dinamica</strong> e quindi <strong>tutti gli stati</strong> di quel range temporale. In pratica, è sufficiente chiamare <code>odeint</code> una sola volta con tutti i tempi nel range 
desiderato, e il modello restituirà <strong>l'intera traiettoria</strong> prevista. Ma bando alle parole e vediamo come se la sono cavata le nostre reti a <strong>predire il futuro</strong>.</p>
<p class="image-caption"><img alt="LVMLPPred" class="image" src="https://www.lucadivita.it/it/images/teoria_matematica/neural_ode_5/LotkaVolterra_predictions_mlp.svg"/>
Figura 4. Forecast di Lotka-Volterra con <code>SimpleNet</code></p>
<p class="image-caption"><img alt="LVNODEPred" class="image" src="https://www.lucadivita.it/it/images/teoria_matematica/neural_ode_5/LotkaVolterra_predictions_node.svg"/>
Figura 5. Forecast di Lotka-Volterra con <code>NODE</code></p>
<p>Già dai video del train si poteva intuire che <code>SimpleNet</code> non era andata proprio <strong>egregiamente</strong>. E vedendo il forecast possiamo dire a cuore leggero che
<strong>non ha capito una fava</strong> e infatti il suo forecast é, a dir poco, <strong>osceno</strong> già dal secondo step. Vediamo che la <code>NODE</code> invece, sembra
aver capito molto bene la dinamica dato che riesce a fare una <strong>buona predizione</strong> di tutti gli stati su una finestra temporale <strong>molto ampia</strong>.</p>
<p>In conclusione, la NODE non solo ha dimostrato di <strong>adattarsi</strong> bene ai dati, ma ha saputo <strong>generalizzare</strong> su una finestra temporale mai vista. 
Certo, la NODE ci mette molto di più, ma come diceva qualcuno: la <strong>qualità</strong> ha il suo prezzo.</p>
<h4 id="loscillatore-armonico">L'Oscillatore Armonico<a class="headerlink" href="#loscillatore-armonico" title="Permanent link"> </a></h4>
<p>Il secondo problema affrontato é quello dell'<strong>oscillatore armonico</strong>. Non rispiegherò tutti i passaggi dato che sono praticamente gli <strong>stessi</strong> visti sopra ma con dati diversi.
In questo paragrafo mi limiterò a dire come sono passato da un <strong>problema fisico</strong> ad un <strong>modello matematico</strong>, e vedremo i soli risultati del <strong>forecast</strong>.</p>
<p>Partiamo dal classico esercizietto di fisica dove c'è una <strong>massa attaccata ad una molla</strong>, come nell'immagine che segue.</p>
<p class="image-caption"><img alt="Oscillatore" class="image" src="https://www.lucadivita.it/it/images/teoria_matematica/neural_ode_5/oscillatore.png"/>
Figura 6. Massa Attaccata ad una Molla</p>
<p>Se provaste a <strong>tirare e rilasciare</strong> la massa, quest'ultima <strong>oscillerebbe</strong> intorno al suo punto di equilibro fino a tornare alla <strong>situazione stabile</strong> in cui è fermo. 
Questo moto si chiama oscillatore armonico. Vediamone le <strong>leggi fisiche</strong>. Dalla legge di Newton sappiamo che una forza è pari alla massa per una accelerazione. 
Ma cosa è una accelerazione? Dalla <a href="https://www.lucadivita.it/it/teoria-matematica/i-ode-you-ode-and-the-neural-ode-1/">parte 1</a> sappiamo che la velocità è 
la derivata prima dello spazio rispetto al tempo. Dato che l'accelerazione è la derivata prima della velocità rispetto al tempo, abbiamo di conseguenza, 
che l'accelerazione è la <strong>derivata seconda</strong> dello spazio rispetto al tempo. Nell'immagine in alto noi uno spazio lo abbiamo. E' la <strong>distanza</strong> tra la <strong>massa</strong> <span class="math">\(m\)</span> e il suo 
<strong>punto di equilibrio</strong>, e nell'immagine è <span class="math">\(x\)</span>. Per cui scriviamo:</p>
<div class="math">$$
F_{tot} = m \cdot a = m \frac{d^{2}x(t)}{dt^{2}}
$$</div>
<p>Ma dalla <strong>legge di Hooke</strong> sappiamo che la <strong>forza elastica</strong> è una forza opposta allo spostamento fatto che dipende dalla <strong>costante elastica</strong> <span class="math">\(k\)</span> della molla
e dallo spostamento stesso, per cui possiamo scrivere:</p>
<div class="math">$$
F_{el} = -k \cdot x(t)
$$</div>
<p>Quindi, se non ci sono altre forze in gioco, la <strong>forza totale</strong> è data dalla sola componente elastica. Per cui scriviamo:</p>
<div class="math">$$
F_{tot} = F_{el} \Rightarrow m \frac{d^{2}x(t)}{dt^{2}} = -k \cdot x(t)
$$</div>
<p>Supponiamo che la massa posi su un <strong>pavimento di plastica</strong> che fa molto <strong>attrito</strong>. Per definizione una forza di attrito è pari alla <strong>velocità</strong> per un 
<strong>coefficiente di attrito</strong>. La velocità come abbiamo detto, è la derivata prima dello spazio rispetto al tempo. Inoltre, essendo una forza <strong>dissipativa</strong>, sottrae 
energia al sistema. Quindi scriviamo:</p>
<div class="math">$$
F_{att} = - \beta \cdot \frac{dx(t)}{dt}
$$</div>
<p>Considerando anche questa forza in tutto il sistema, abbiamo:</p>
<div class="math">$$
F_{tot} = F_{el} + F_{att} \Rightarrow m \frac{d^{2}x(t)}{dt^{2}} = -k \cdot x(t) - \beta \cdot \frac{dx(t)}{dt}
$$</div>
<p>Da cui</p>
<div class="math">$$
\frac{d^{2}x(t)}{dt^{2}} = -\frac{k}{m} \cdot x(t) - \frac{\beta}{m} \cdot \frac{dx(t)}{dt}
$$</div>
<p>Ponendo:</p>
<div class="math">$$
-\frac{k}{m} = \omega^2, \, \frac{\beta}{m} = \gamma
$$</div>
<p>Dove <span class="math">\(\omega^2\)</span> è chiamato <strong>frequenza naturale dell'oscillatore</strong> e <span class="math">\(\gamma\)</span> <strong>coefficiente di smorzamento</strong>. Quindi:</p>
<div class="math">$$
\frac{d^{2}x(t)}{dt^{2}} + \gamma \frac{dx(t)}{dt}  + \omega^2 \cdot x(t) = 0
$$</div>
<p>Siamo arrivati alla <strong>forma differenziale</strong> dell'oscillatore armonico. Ma ancora non abbiamo finito, perché gli ODESolver lavorano solo con <strong>equazioni differenziali di 
primo grado</strong>, quindi cosi come é non sappiamo cosa farcene. Allora scomodiamo una <strong>proprietà</strong> delle equazioni differenziali, in particolare quella che dice che:</p>
<blockquote>
<p>Ogni equazione differenziale ordinaria di ordine <span class="math">\(n\)</span>, può essere riscritta come un sistema equivalente di <span class="math">\(n\)</span> equazioni del primo ordine.</p>
</blockquote>
<p>Facciamo quindi un semplice <strong>cambio di variabile</strong> e poniamo:</p>
<div class="math">$$
x_1(t) = x(t), \, x_2(t) = \frac{dx(t)}{dt} = \frac{dx_1(t)}{dt} \Rightarrow \frac{dx_2(t)}{dt} = \frac{dx^2(t)}{dt^2} = \frac{dx_1^2(t)}{dt^2}
$$</div>
<p>Dopo questo cambio di variabili possiamo scrivere la precedente equazione differenziale di ordine due, in due equazioni differenziali del <strong>primo ordine</strong>:</p>
<div class="math">$$
\begin{cases}
\frac{dx_1(t)}{dt} = x_2(t) \\
\frac{dx_2(t)}{dt} = - \omega^2 \cdot x_1(t) - \gamma \cdot x_2(t)
\end{cases}
$$</div>
<p>Questa è una forma che un ODESolver può risolvere e rappresenta la nostra <strong>dinamica da risolvere</strong>. In termini di codice questa dinamica diventa:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">HarmonicOscillator</span><span class="p">(</span><span class="n">DatasetProvider</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_train</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">80</span><span class="p">,</span> <span class="n">noise_std</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span> <span class="n">t_train_range</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">),</span>
                 <span class="n">t_extra_range</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">15.0</span><span class="p">),</span> <span class="n">n_extra</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span> <span class="n">n_resamp</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span> <span class="n">omega</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
                 <span class="n">gamma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">initial_values</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">initial_values</span><span class="o">=</span><span class="n">initial_values</span><span class="p">,</span> <span class="n">n_train</span><span class="o">=</span><span class="n">n_train</span><span class="p">,</span> <span class="n">noise_std</span><span class="o">=</span><span class="n">noise_std</span><span class="p">,</span>
                         <span class="n">t_train_range</span><span class="o">=</span><span class="n">t_train_range</span><span class="p">,</span> <span class="n">t_extra_range</span><span class="o">=</span><span class="n">t_extra_range</span><span class="p">,</span> <span class="n">n_extra</span><span class="o">=</span><span class="n">n_extra</span><span class="p">,</span>
                         <span class="n">n_resamp</span><span class="o">=</span><span class="n">n_resamp</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">omega</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">omega</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">gamma</span><span class="p">)</span>

    <span class="o">...</span>

    <span class="k">def</span> <span class="nf">dynamics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
        <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">state</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">x1dt</span> <span class="o">=</span> <span class="n">x2</span>
        <span class="n">x2dt</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">omega</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">x1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span> <span class="o">*</span> <span class="n">x2</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">x1dt</span><span class="p">,</span> <span class="n">x2dt</span><span class="p">])</span>

    <span class="o">...</span>
</code></pre></div>
<p>Il resto, come si suol dire, è storia. Per cui mi limito a riportare i grafici del <strong>forecast</strong>:</p>
<p class="image-caption"><img alt="HOMLPPred" class="image" src="https://www.lucadivita.it/it/images/teoria_matematica/neural_ode_5/HarmonicOscillator_predictions_mlp.svg"/>
Figura 7. Forecast dell'Oscillatore Armonico con <code>SimpleNet</code></p>
<p class="image-caption"><img alt="HONODEPred" class="image" src="https://www.lucadivita.it/it/images/teoria_matematica/neural_ode_5/HarmonicOscillator_predictions_node.svg"/>
Figura 8. Forecast dell'Oscillatore Armonico con <code>NODE</code></p>
<p>Da questi grafici possiamo vedere come, ancora una volta, la NODE sembra aver <strong>compreso</strong> la dinamica mentre la rete classica la si nota un <em>pochino</em> confusa.</p>
<p>Insomma per tirare le somme, le NODE hanno dimostrato il loro potenziale, soprattutto in contesti dove c'è <strong>dinamica continua</strong>. </p>
<p>Sono <strong>lente</strong>? Sì. </p>
<p>Sono <strong>pesanti</strong> da integrare? Pure. </p>
<p>Sono difficile da <strong>tunare</strong>? Anche. </p>
<p>Ma sanno imparare come si evolve un sistema, e sanno farlo bene. Con occupazione spaziale <strong>costante</strong>, architetture più <strong>semplici</strong> e una spiccata capacità di <strong>generalizzazione</strong>.</p>
<h3 id="conclusioni">Conclusioni<a class="headerlink" href="#conclusioni" title="Permanent link"> </a></h3>
<p>Chiudiamo, finalmente, questa serie di articoli sulle NODE. E' stato un viaggio lungo e, diciamocelo, <strong>faticoso</strong>. Sia per me che per voi. Però dai, ci portiamo a casa un bel bagaglio, no?
Prima di concludere, ci terrei a mettere i <strong>puntini</strong> sulle i su un paio di aspetti. Partiamo dalle reti classiche, che qui sembrano un pò <strong>bistrattate</strong>. In realtà non è 
così. Per mantenere il confronto equo ho usato <strong>un solo approccio di train</strong>, ma con le giuste attenzioni anche una rete classica può cavarsela <strong>egregiamente</strong>. L'altro punto da sollevare è sulle NODE. 
Ho finito la serie di articoli, è vero, ma le NODE sono solo la base. Coloro che hanno dato il via. Qui le ho utilizzate per fare forecast ma, esattamente come le reti classiche, si possono usare per classificazione, regressione, generazione... E non solo: dalle NODE 
nascono tante altre architetture interessanti. Dai <strong>CNF</strong> per la generazione di immagini, alle <a href="https://arxiv.org/pdf/2006.04439"><strong>Liquid Neural Network</strong></a> per robotica e controllo, fino alle <a href="https://arxiv.org/pdf/2503.18181"><strong>Physics Informed 
Neural Network</strong></a> (Reti Lagrangiane, Reti Hamiltoniane, ...) reti che incorporano la fisica per modellare fenomeni complessi. Insomma, chi più ne ha più ne metta. E ognuna
di queste architetture merita una <strong>dissertazione</strong> a parte. Chissà, magari un giorno ve la propinerò.</p>
<p>Detto questo, vi invito come sempre a leggere il codice completo <a href="https://github.com/lucadivit/NeuralODEBlog/tree/main/part_5"><strong>qui</strong></a> e anche a lanciarlo voi stessi.</p>
<p>Alla Prossima.</p>
<script type="text/javascript">if (!document.getElementById('mathjaxscript_pelican_#%@#$@#')) {
    var align = "center",
        indent = "0em",
        linebreak = "false";

    if (false) {
        align = (screen.width < 768) ? "left" : align;
        indent = (screen.width < 768) ? "0em" : indent;
        linebreak = (screen.width < 768) ? 'true' : linebreak;
    }

    var mathjaxscript = document.createElement('script');
    mathjaxscript.id = 'mathjaxscript_pelican_#%@#$@#';
    mathjaxscript.type = 'text/javascript';
    mathjaxscript.src = 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.3/latest.js?config=TeX-AMS-MML_HTMLorMML';

    var configscript = document.createElement('script');
    configscript.type = 'text/x-mathjax-config';
    configscript[(window.opera ? "innerHTML" : "text")] =
        "MathJax.Hub.Config({" +
        "    config: ['MMLorHTML.js']," +
        "    TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'none' } }," +
        "    jax: ['input/TeX','input/MathML','output/HTML-CSS']," +
        "    extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']," +
        "    displayAlign: '"+ align +"'," +
        "    displayIndent: '"+ indent +"'," +
        "    showMathMenu: false," +
        "    messageStyle: 'normal'," +
        "    tex2jax: { " +
        "        inlineMath: [ ['\\\\(','\\\\)'] ], " +
        "        displayMath: [ ['$$','$$'] ]," +
        "        processEscapes: true," +
        "        preview: 'TeX'," +
        "    }, " +
        "    'HTML-CSS': { " +
        "        availableFonts: ['STIX', 'TeX']," +
        "        preferredFont: 'STIX'," +
        "        styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: 'inherit ! important'} }," +
        "        linebreaks: { automatic: "+ linebreak +", width: '90% container' }," +
        "    }, " +
        "}); " +
        "if ('default' !== 'default') {" +
            "MathJax.Hub.Register.StartupHook('HTML-CSS Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax['HTML-CSS'].FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
            "MathJax.Hub.Register.StartupHook('SVG Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax.SVG.FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
        "}";

    (document.body || document.getElementsByTagName('head')[0]).appendChild(configscript);
    (document.body || document.getElementsByTagName('head')[0]).appendChild(mathjaxscript);
}
</script>


             
 
            
            
            







            <hr/>
<section>
    <h3 id="Consigliati">
        Consigliati
        <a class="headerlink" href="#Consigliati" title="Permanent link"> </a>
    </h3>
<ul class="related-posts-list">
<li><a href="https://www.lucadivita.it/it/teoria-matematica/i-ode-you-ode-and-the-neural-ode-1/" title="Io ODO, Tu ODI e la Neural ODE - 1">Io ODO, Tu ODI e la Neural ODE - 1</a></li>
<li><a href="https://www.lucadivita.it/it/teoria-matematica/i-ode-you-ode-and-the-neural-ode-2/" title="Io ODO, Tu ODI e la Neural ODE - 2">Io ODO, Tu ODI e la Neural ODE - 2</a></li>
<li><a href="https://www.lucadivita.it/it/teoria-matematica/i-ode-you-ode-and-the-neural-ode-3/" title="Io ODO, Tu ODI e la Neural ODE - 3">Io ODO, Tu ODI e la Neural ODE - 3</a></li>
<li><a href="https://www.lucadivita.it/it/teoria-matematica/i-ode-you-ode-and-the-neural-ode-4/" title="Io ODO, Tu ODI e la Neural ODE - 4">Io ODO, Tu ODI e la Neural ODE - 4</a></li>
</ul>
</section>
<section class="references">
    <h3 id="Riferimenti">
        Riferimenti
        <a class="headerlink" href="#Riferimenti" title="Permanent link"> </a>
    </h3>
    <ul class="related-posts-list">
        <li>
            <a href="https://www.lucadivita.it/it/teoria-matematica/i-ode-you-ode-and-the-neural-ode-3/">https://www.lucadivita.it/it/teoria-matematica/i-ode-you-ode-and-the-neural-ode-3/</a>
        </li>
        <li>
            <a href="https://github.com/rtqichen/torchdiffeq">https://github.com/rtqichen/torchdiffeq</a>
        </li>
        <li>
            <a href="https://en.wikipedia.org/wiki/Dormand%E2%80%93Prince_method">https://en.wikipedia.org/wiki/Dormand%E2%80%93Prince_method</a>
        </li>
        <li>
            <a href="https://github.com/rtqichen/torchdiffeq/blob/master/FAQ.md">https://github.com/rtqichen/torchdiffeq/blob/master/FAQ.md</a>
        </li>
        <li>
            <a href="https://www.lucadivita.it/it/teoria-matematica/i-ode-you-ode-and-the-neural-ode-4/">https://www.lucadivita.it/it/teoria-matematica/i-ode-you-ode-and-the-neural-ode-4/</a>
        </li>
        <li>
            <a href="https://www.lucadivita.it/it/machine-learning/neurons-for-dummies-1/">https://www.lucadivita.it/it/machine-learning/neurons-for-dummies-1/</a>
        </li>
        <li>
            <a href="https://docs.pytorch.org/docs/stable/generated/torch.nn.MSELoss.html">https://docs.pytorch.org/docs/stable/generated/torch.nn.MSELoss.html</a>
        </li>
        <li>
            <a href="https://www.lucadivita.it/it/teoria-matematica/i-ode-you-ode-and-the-neural-ode-1/">https://www.lucadivita.it/it/teoria-matematica/i-ode-you-ode-and-the-neural-ode-1/</a>
        </li>
        <li>
            <a href="https://arxiv.org/pdf/2006.04439">https://arxiv.org/pdf/2006.04439</a>
        </li>
        <li>
            <a href="https://arxiv.org/pdf/2503.18181">https://arxiv.org/pdf/2503.18181</a>
        </li>
        <li>
            <a href="https://github.com/lucadivit/NeuralODEBlog/tree/main/part_5">https://github.com/lucadivit/NeuralODEBlog/tree/main/part_5</a>
        </li>
        <li>
            <a href="http://eotvos.dm.unipi.it/corsi/Fisica1_1415/OscillatoreArmonico1e2.pdf">http://eotvos.dm.unipi.it/corsi/Fisica1_1415/OscillatoreArmonico1e2.pdf</a>
        </li>
        <li>
            <a href="https://math.mit.edu/~stevenj/18.336/adjoint.pdf">https://math.mit.edu/~stevenj/18.336/adjoint.pdf</a>
        </li>
    </ul>
</section>
        </div>
        <section id="article-sidebar" class="span2">
            <h4>Pubblicato</h4>
            <time itemprop="dateCreated" datetime="2025-10-01T00:00:00+02:00">01 ottobre 2025</time>
            <h4>Argomento</h4>
            <a class="category-link" href="https://www.lucadivita.it/it/categories.html#teoria-matematica-ref">Teoria & Matematica</a>
            <h4>Tags</h4>
            <ul class="list-of-tags tags-in-article">
                <li><a href="https://www.lucadivita.it/it/tags.html#deep_learning-ref">deep_learning
                    <span class="superscript">8</span>
</a></li>
                <li><a href="https://www.lucadivita.it/it/tags.html#equazioni_differenziali-ref">equazioni_differenziali
                    <span class="superscript">5</span>
</a></li>
                <li><a href="https://www.lucadivita.it/it/tags.html#matematica-ref">matematica
                    <span class="superscript">8</span>
</a></li>
                <li><a href="https://www.lucadivita.it/it/tags.html#metodi_numerici-ref">metodi_numerici
                    <span class="superscript">4</span>
</a></li>
                <li><a href="https://www.lucadivita.it/it/tags.html#neural_ode-ref">neural_ode
                    <span class="superscript">5</span>
</a></li>
                <li><a href="https://www.lucadivita.it/it/tags.html#ode-ref">ode
                    <span class="superscript">5</span>
</a></li>
                <li><a href="https://www.lucadivita.it/it/tags.html#reti_neurali-ref">reti_neurali
                    <span class="superscript">9</span>
</a></li>
                <li><a href="https://www.lucadivita.it/it/tags.html#teoria-ref">teoria
                    <span class="superscript">5</span>
</a></li>
            </ul>
<h4>Contatti</h4>
<div id="sidebar-social-link">
    <a href="mailto:lucadivita.ldv@gmail.com" title="Gmail" target="_blank" rel="nofollow noopener noreferrer">
        <svg xmlns="http://www.w3.org/2000/svg" aria-label="Gmail" role="img" viewBox="0 0 512 512"><rect width="512" height="512" rx="15%" fill="#fff"/><rect width="362" height="272" x="75" y="120" fill="#f2f2f2" rx="8%"/><path fill="#d54c3f" d="M120 392H97c-12 0-22-10-22-23V143h45z"/><path fill="#b63524" d="M392 392h23c12 0 22-10 22-23V143h-45z"/><path fill-opacity=".05" d="M256 286L120 392V187z"/><path fill-opacity=".08" d="M82 159l235 233h75V159z"/><path stroke-linecap="round" fill="none" stroke="#de5145" stroke-width="45" d="M97 143l159 115 159-115"/><path fill="#f2f2f2" d="M415 120c-5 0-10 2-13 4L256 230 110 124c-3-2-8-4-13-4z"/></svg>
    </a>
    <a href="https://www.instagram.com/luca_di_vita_/" title="Instagram" target="_blank" rel="nofollow noopener noreferrer">
        <svg xmlns="http://www.w3.org/2000/svg" aria-label="Instagram" role="img" viewBox="0 0 512 512"><rect width="512" height="512" rx="15%" fill="#d43377"/><g fill="none" stroke="#fff" stroke-width="29"><rect height="296" rx="78" width="296" x="108" y="108"/><circle cx="256" cy="256" r="69"/></g><circle cx="343" cy="169" fill="#fff" r="19"/></svg>
    </a>
    <a href="https://www.linkedin.com/in/lucadivit/" title="LinkedIn" target="_blank" rel="nofollow noopener noreferrer">
        <svg xmlns="http://www.w3.org/2000/svg" aria-label="LinkedIn" role="img" viewBox="0 0 512 512" fill="#fff"><rect width="512" height="512" rx="15%" fill="#0077b5"/><circle cx="142" cy="138" r="37"/><path stroke="#fff" stroke-width="66" d="M244 194v198M142 194v198"/><path d="M276 282c0-20 13-40 36-40 24 0 33 18 33 45v105h66V279c0-61-32-89-76-89-34 0-51 19-59 32"/></svg>
    </a>
    <a href="https://github.com/lucadivit" title="GitHub" target="_blank" rel="nofollow noopener noreferrer">
        <svg xmlns="http://www.w3.org/2000/svg" aria-label="GitHub" role="img" viewBox="0 0 512 512">
            <rect width="512" height="512" rx="15%" fill="#1B1817"/>
            <path fill="#fff" d="M335 499c14 0 12 17 12 17H165s-2-17 12-17c13 0 16-6 16-12l-1-50c-71 16-86-28-86-28-12-30-28-37-28-37-24-16 1-16 1-16 26 2 40 26 40 26 22 39 59 28 74 22 2-17 9-28 16-35-57-6-116-28-116-126 0-28 10-51 26-69-3-6-11-32 3-67 0 0 21-7 70 26 42-12 86-12 128 0 49-33 70-26 70-26 14 35 6 61 3 67 16 18 26 41 26 69 0 98-60 120-117 126 10 8 18 24 18 48l-1 70c0 6 3 12 16 12z"/>
        </svg>
    </a>
    <a href="https://gitlab.com/lucadivit" title="GitLab" target="_blank" rel="nofollow noopener noreferrer">
        <svg xmlns="http://www.w3.org/2000/svg" aria-label="GitLab" role="img" viewBox="0 0 512 512"><rect width="512" height="512" rx="15%" fill="#30353e"/><path fill="#e24329" d="M84 215l43-133c2-7 12-7 14 0l115 353L371 82c2-7 12-7 14 0l43 133"/><path fill="#fc6d26" d="M256 435L84 215h100.4zm71.7-220H428L256 435l71.6-220z"/><path fill="#fca326" d="M84 215l-22 67c-2 6 0 13 6 16l188 137zm344 0l22 67c2 6 0 13-6 16L256 435z"/></svg>
    </a>
    <a href="https://sessionize.com/lucadivit/" title="Sessionize" target="_blank" rel="nofollow noopener noreferrer">
        <svg xmlns="http://www.w3.org/2000/svg" aria-label="Sessionize" role="img" viewBox="0 0 225 225" preserveAspectRatio="xMidYMid meet" style="border-radius: 15%">
            <rect width="512" height="512" rx="15%" fill="#1B1817"/>
            <path d="M0 0 C74.25 0 148.5 0 225 0 C225 74.25 225 148.5 225 225 C150.75 225 76.5 225 0 225 C0 150.75 0 76.5 0 0 Z " fill="#19B293" transform="translate(0,0)"/>
            <path d="M0 0 C1.31599686 -0.00953201 2.63199371 -0.01906403 3.98786926 -0.02888489 C5.43030829 -0.02862319 6.87274734 -0.02768483 8.31518555 -0.02612305 C9.80193704 -0.03001372 11.28868743 -0.03434916 12.7754364 -0.03910828 C15.9001321 -0.04657848 19.0247149 -0.04627702 22.14941406 -0.04101562 C26.11536182 -0.03527182 30.08083476 -0.05202298 34.04670429 -0.0753603 C37.12435015 -0.0902552 40.20188646 -0.09094734 43.279562 -0.08785057 C44.73890294 -0.08835765 46.19825104 -0.09347759 47.65755653 -0.10366249 C69.14532107 -0.23502938 87.02075403 5.26310965 102.8894043 19.9621582 C110.67057737 28.23789736 116.58232444 38.34520174 119.6394043 49.2746582 C119.97875 50.32194092 120.3180957 51.36922363 120.66772461 52.44824219 C122.33895379 59.21584233 121.94745978 66.26579559 121.94018555 73.19262695 C121.94407817 74.73863336 121.948414 76.28463871 121.95317078 77.8306427 C121.96060081 81.05737797 121.96036363 84.28400372 121.95507812 87.51074219 C121.94926476 91.63996754 121.96627466 95.76874707 121.9894228 99.89789867 C122.00416425 103.08497219 122.00503169 106.27193812 122.00191307 109.45903969 C122.00242532 110.98164063 122.00764501 112.50424775 122.01772499 114.02681541 C122.03009091 116.15423979 122.0232996 118.28079226 122.01171875 120.40820312 C122.01234818 121.61651291 122.0129776 122.82482269 122.0136261 124.06974792 C121.49507938 128.51068565 119.93321686 131.13005383 116.61132812 134.06884766 C112.12728909 135.88817476 107.88024462 135.64330395 103.08862305 135.56762695 C102.07467972 135.56338211 101.06073639 135.55913727 100.0160675 135.55476379 C96.7860733 135.53800679 93.55670908 135.50035942 90.3269043 135.4621582 C88.13355395 135.44710754 85.9401938 135.43341981 83.74682617 135.42114258 C78.37747157 135.38811307 73.00848295 135.33794314 67.6394043 135.2746582 C67.55831421 134.17275146 67.55831421 134.17275146 67.47558594 133.04858398 C67.39687256 132.0738916 67.31815918 131.09919922 67.23706055 130.0949707 C67.16237549 129.13349121 67.08769043 128.17201172 67.01074219 127.18139648 C65.85127395 118.10537487 61.31660105 111.35722519 54.6394043 105.2746582 C52.34547142 103.67192921 50.17315922 102.48874911 47.6394043 101.2746582 C50.63173573 98.85814791 53.59550826 97.25526048 57.1081543 95.70043945 C58.2202124 95.20519775 59.33227051 94.70995605 60.47802734 94.19970703 C61.07336273 93.93751373 61.66869812 93.67532043 62.28207397 93.40518188 C64.16867062 92.57426844 66.05237307 91.73707693 67.93554688 90.8984375 C74.6131471 87.92808819 81.3015826 84.98228965 87.98959351 82.03547668 C91.29295183 80.57903822 94.59488329 79.11938032 97.89672852 77.65951538 C100.30665369 76.59609413 102.7190391 75.53840104 105.1315918 74.48095703 C106.61737501 73.82519159 108.10305715 73.16919707 109.58862305 72.51293945 C110.27377487 72.21452148 110.9589267 71.91610352 111.6648407 71.60864258 C114.41185831 70.3896352 116.49455798 69.41950452 118.6394043 67.2746582 C117.61202148 66.85055664 116.58463867 66.42645508 115.52612305 65.98950195 C87.28595015 54.12733031 67.55569174 34.60394077 55.9519043 6.38012695 C54.9449732 3.45487798 54.9449732 3.45487798 53.6394043 2.2746582 C53.18839355 3.30719727 52.73738281 4.33973633 52.27270508 5.40356445 C42.53358817 27.68958682 32.69808257 49.92811976 22.67333984 72.08724976 C21.64957628 74.3550725 20.63173403 76.6254818 19.61450195 78.89624023 C18.29286769 81.84312633 16.94032637 84.7730835 15.56665039 87.69604492 C14.9175196 89.10626958 14.26858503 90.51658459 13.61987305 91.92700195 C13.31793533 92.55224258 13.01599762 93.17748322 12.70491028 93.82167053 C10.54136532 98.58578335 10.25387891 102.15001625 10.6394043 107.2746582 C11.95642312 109.88889673 11.95642312 109.88889673 14.6394043 111.2746582 C17.47883301 111.92556465 20.29914908 112.10079214 23.2019043 112.2746582 C31.96293627 113.04515811 40.76023837 113.82063152 47.2019043 120.4621582 C50.44815395 124.78425428 51.6394043 129.91246632 51.6394043 135.2746582 C44.18094298 135.39075406 36.72267798 135.47947465 29.26349449 135.53371906 C25.79944205 135.55976046 22.33600992 135.59505512 18.87231445 135.65185547 C14.88590036 135.71681507 10.89973324 135.74088407 6.9128418 135.76293945 C5.67513031 135.78874588 4.43741882 135.81455231 3.16220093 135.84114075 C-6.44183312 135.84426546 -6.44183312 135.84426546 -10.12768555 132.93164062 C-13.12362778 129.36671177 -13.4857942 126.89417722 -13.50776672 122.39187622 C-13.51492203 121.38527954 -13.52207733 120.37868286 -13.52944946 119.34158325 C-13.53213837 118.23813568 -13.53482727 117.13468811 -13.53759766 115.99780273 C-13.54745445 114.25355011 -13.54745445 114.25355011 -13.55751038 112.47406006 C-13.57725319 108.61852966 -13.5889068 104.76303818 -13.59887695 100.9074707 C-13.60295248 99.5925552 -13.60702801 98.27763969 -13.61122704 96.92287827 C-13.63027063 90.68384023 -13.64450465 84.44481399 -13.652839 78.20575249 C-13.66261549 71.00634951 -13.6889488 63.80725366 -13.7293399 56.60795891 C-13.75950045 51.04098472 -13.77430771 45.4740986 -13.77762002 39.90704429 C-13.77997019 36.58291276 -13.79089828 33.25918478 -13.81408119 29.93512344 C-13.83834245 26.22659878 -13.83753116 22.51888191 -13.83056641 18.81030273 C-13.84337646 17.71090363 -13.85618652 16.61150452 -13.86938477 15.47879028 C-13.81838403 8.04414793 -13.81838403 8.04414793 -11.51872253 4.17868042 C-7.48809963 0.62263568 -5.2978389 0.02105833 0 0 Z " fill="#FEFEFE" transform="translate(58.360595703125,44.725341796875)"/>
            <path d="M0 0 C18.47893545 0.34277958 33.23021483 7.00580799 46.6484375 19.55078125 C61.32078135 34.83244171 66.66940421 52.79904366 66.49609375 73.50390625 C66.49624921 75.04133675 66.49774591 76.57876764 66.50050354 78.11619568 C66.5018748 81.30721779 66.48953337 84.49778338 66.46655273 87.6887207 C66.43795261 91.7707473 66.4409809 95.85202988 66.45364285 99.9341135 C66.46060001 103.09547768 66.45281401 106.25667036 66.44038582 109.41801262 C66.43588692 110.92385132 66.4355208 112.42970849 66.43945122 113.93554878 C66.44236953 116.03367084 66.42583673 118.1307676 66.40405273 120.22875977 C66.39864975 121.41897232 66.39324677 122.60918488 66.38768005 123.83546448 C65.84762244 128.24382 64.27261053 130.87415255 60.97192383 133.79418945 C56.48788479 135.61351655 52.24084032 135.36864575 47.44921875 135.29296875 C46.43527542 135.28872391 45.42133209 135.28447906 44.37666321 135.28010559 C41.14666901 135.26334859 37.91730478 135.22570122 34.6875 135.1875 C32.49414965 135.17244934 30.3007895 135.1587616 28.10742188 135.14648438 C22.73806727 135.11345487 17.36907865 135.06328494 12 135 C11.94593994 134.26539551 11.89187988 133.53079102 11.83618164 132.77392578 C11.75746826 131.7992334 11.67875488 130.82454102 11.59765625 129.8203125 C11.52297119 128.85883301 11.44828613 127.89735352 11.37133789 126.90673828 C10.21186965 117.83071667 5.67719676 111.08256699 -1 105 C-3.29393287 103.39727101 -5.46624507 102.2140909 -8 101 C-5.00766857 98.58348971 -2.04389603 96.98060228 1.46875 95.42578125 C2.58080811 94.93053955 3.69286621 94.43529785 4.83862305 93.92504883 C5.43395844 93.66285553 6.02929382 93.40066223 6.64266968 93.13052368 C8.52926633 92.29961024 10.41296877 91.46241873 12.29614258 90.6237793 C18.9737428 87.65342998 25.6621783 84.70763145 32.35018921 81.76081848 C35.65354753 80.30438002 38.955479 78.84472212 42.25732422 77.38485718 C44.6672494 76.32143593 47.0796348 75.26374284 49.4921875 74.20629883 C50.97797072 73.55053338 52.46365286 72.89453886 53.94921875 72.23828125 C54.63437057 71.93986328 55.3195224 71.64144531 56.0254364 71.33398438 C58.77245401 70.114977 60.85515368 69.14484632 63 67 C61.97261719 66.57589844 60.94523437 66.15179688 59.88671875 65.71484375 C33.50645147 54.63391802 13.59780668 36.53480254 1.875 10.3125 C1.56731689 9.62905518 1.25963379 8.94561035 0.94262695 8.24145508 C-1.12599038 3.37797114 -1.12599038 3.37797114 0 0 Z " fill="#FDFEFE" transform="translate(114,45)"/>
            <path d="M0 0 C18.47893545 0.34277958 33.23021483 7.00580799 46.6484375 19.55078125 C57.82695197 31.19351975 66.22886216 46.95089512 66.25 63.375 C66.18776003 64.91766223 66.11312576 66.46023277 66 68 C37.79431797 57.57100832 15.66661801 40.31717625 2.83447266 12.46142578 C2.51784668 11.75228027 2.2012207 11.04313477 1.875 10.3125 C1.56739746 9.62913574 1.25979492 8.94577148 0.94287109 8.24169922 C-1.1260832 3.3782496 -1.1260832 3.3782496 0 0 Z " fill="#FBFDFD" transform="translate(114,45)"/>
            <path d="M0 0 C5.31132099 1.67208253 9.71465315 5.34510004 12.6328125 10.12109375 C13.62643421 12.72019895 13.10644906 14.4292834 12.375 17.0625 C10.25 17.8125 10.25 17.8125 7.375 18.0625 C2.55583514 15.5525183 -0.55382918 12.44988688 -3.625 8.0625 C-4.5625 4.8125 -4.5625 4.8125 -4.625 2.0625 C-2.625 0.0625 -2.625 0.0625 0 0 Z " fill="#1DB495" transform="translate(144.625,66.9375)"/>
        </svg>
    </a>
    <a href="https://www.lucadivita.it/feeds/luca-di-vita.rss.xml" title="RSS" target="_blank" rel="nofollow noopener noreferrer">
        <svg xmlns="http://www.w3.org/2000/svg" aria-label="RSS" role="img" viewBox="0 0 512 512"><rect width="512" height="512" rx="15%" fill="#f80"/><circle cx="145" cy="367" r="35" fill="#fff"/><path fill="none" stroke="#fff" stroke-width="60" d="M109 241c89 0 162 73 162 162M109 127c152 0 276 124 276 276"/></svg>
    </a>
</div>
            





            





        </section>
</div>
</article>
<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe.
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides.
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo https://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>                    </div>
                    <div class="span1"></div>
                </div>
            </div>
        </div>
<footer>




    <div id="fpowered">
        Powered by: <a href="http://getpelican.com/" title="Pelican Home Page" target="_blank" rel="nofollow noopener noreferrer">Pelican</a>
        Theme: <a href="https://elegant.oncrashreboot.com/" title="Theme Elegant Home Page" target="_blank" rel="nofollow noopener noreferrer">Elegant</a>
    </div>
</footer>            <script src="//code.jquery.com/jquery.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
        <script src="/js/elegant.prod.9e9d5ce754.js"></script>
        <script src="/js/custom.js"></script>
        <!--
        <script src="/js/MathJax.js"></script>
        <script src="/js/MathMenu.js"></script>
        <script src="/js/MathZoom.js"></script>-->
        <script type="text/javascript">
          (() => {
            document.querySelectorAll('a').forEach(a => {
              if (a.host !== window.location.host && !a.getAttribute('data-umami-event')) {
                a.setAttribute('data-umami-event', "Click " + a.ariaLabel);
                a.setAttribute('data-umami-event-element', "anchor");
                a.setAttribute('data-umami-event-event', "onclick");
                a.setAttribute('data-umami-event-id', a.id);
                a.setAttribute('data-umami-event-url', a.href);
              }
            });
          })();
        </script>

    <script>
    (function () {
        if (window.location.hash.match(/^#comment-\d+$/)) {
            $('#comment_thread').collapse('show');
        }
    })();
    window.onhashchange=function(){
        if (window.location.hash.match(/^#comment-\d+$/))
            window.location.reload(true);
    }
    $('#comment_thread').on('shown', function () {
        var link = document.getElementById('comment-accordion-toggle');
        var old_innerHTML = link.innerHTML;
        $(link).fadeOut(200, function() {
            $(this).text('Click here to hide comments').fadeIn(200);
        });
        $('#comment_thread').on('hidden', function () {
            $(link).fadeOut(200, function() {
                $(this).text(old_innerHTML).fadeIn(200);
            });
        })
    })
</script>

    </body>
</html>